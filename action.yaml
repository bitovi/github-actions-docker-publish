# action.yml
name: 'Docker Build Tag Publish'
description: 'Build, Tag, and, and Publish a docker image'
branding: 
  icon: tag
  color: red
inputs:
  checkout:
    description: Checkout the repository
    required: false
    default: 'true'
  image_tag:
    description: Tag to override default Logic
    required: false
    default: 'null'
  use_sha:
    description: Use the SHA for the tag.  Overrides the default logic.
    required: false
    default: 'false'
  

runs:
  using: "composite"
  steps:
    - name: Checkout if required
      if: ${{ inputs.checkout == 'true' }}
      uses: actions/checkout@v3
    - name: Tagging Logic
      shell: bash
      run: |
        default=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
        echo "Default branch: $default"
        echo "default=$default" >> $GITHUB_ENV
        ref=${GITHUB_REF##*/}
        head=${GITHUB_HEAD_REF}
        echo "Ref: $ref"
        printenv
        if [[ ${{ GITHUB_EVENT_NAME }} == 'pull_request' ]]
          then
            tag="pr-$head"
            echo "Pull Request"
        elif [[ '${{ inputs.image_tag }}' != 'null' ]]
          then  
            tag='${{ inputs.image_tag }}'
            echo "Tag provided"
        elif [[ '${{ inputs.sha }}' == 'true' ]]
          then  
            tag=${GITHUB_SHA}
            echo "Using SHA"
        elif  [[ $ref == $default ]]
          then  
            tag="latest"
            echo "Latest"
        else
            tag=$ref
            echo "using $ref"
        fi
        echo "Tag is: $tag"
        echo "tag=$tag" >>  $GITHUB_ENV